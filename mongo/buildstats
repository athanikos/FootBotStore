db.events.updateMany({},{$unset:{AwayTeamStats:""}  })
db.events.updateMany({},{$unset:{HomeTeamStats:""}  })
db.events.updateMany({},{$unset:{stats:""}  })
var inputLeagueName = "Eredivisie";
var numberOfPastGames = 7;

db.events.find({league_name:inputLeagueName}).sort({ startingat:1 }).forEach((it)=> { 
    var team1 = it.hometeamname;
    var team2 = it.awayteamname;
  
    var dt = it.startingat;
    var HomeTeamhistoricalMatches = db.events.
    find( {$and:  [{$or:[{hometeamname:team1} ,{awayteamname:team1}]}, {startingat:{$lt:it.startingat}}, {league_name:inputLeagueName}  ]  } ).
    sort({ startingat:-1 });
  
    var AwayTeamhistoricalMatches = db.events.
    find( {$and:  [{$or:[{hometeamname:team2} ,{awayteamname:team2}]}, {startingat:{$lt:it.startingat}}, {league_name:inputLeagueName}  ]  } ).
    sort({ startingat:-1 });
  
    var HomeTeamMatchNumber =   getMatchNumber(it.startingat,HomeTeamhistoricalMatches);
    db.events.update({_id:it._id},{$set:{"MatchNumber":HomeTeamMatchNumber}});
  
    var HomeAvgGoalsScoredUpTo75 = 0;
    var HomeAvgGoalsConcededUpTo75 = 0;
    var HomeAvgGoalsConceded = 0;
    var HomeAvgGoalsScored = 0;
    var PlaysAtHomeorAway ="";
    var HomeTotalMatchCount =0;

    var AwayAvgGoalsScoredUpTo75 = 0;
    var AwayAvgGoalsConcededUpTo75 = 0;
    var AwayAvgGoalsConceded = 0;
    var AwayAvgGoalsScored = 0;
    var PlaysAtHomeorAway ="";
    var AwayTotalMatchCount =0;

    HomeTeamhistoricalMatches.limit(numberOfPastGames).forEach((historicalMatch)=> 
    { 
        if (it.hometeamname ==historicalMatch.hometeamname)
        {
            HomeAvgGoalsScoredUpTo75 +=historicalMatch.homeGoalsUpTo75;
            HomeAvgGoalsScored +=historicalMatch.finalHomeGoals ;
            HomeAvgGoalsConcededUpTo75 += historicalMatch.awayGoalsUpTo75;
            HomeAvgGoalsConceded += historicalMatch.finalAwayGoals;
            PlaysAtHomeorAway = "H";
            HomeTotalMatchCount+=1;
        }
        else     
        {
             AwayAvgGoalsScoredUpTo75 +=historicalMatch.awayGoalsUpTo75;
             AwayAvgGoalsScored +=historicalMatch.finalAwayGoals; 
             AwayAvgGoalsConcededUpTo75 += historicalMatch.homeGoalsUpTo75;
             AwayAvgGoalsConceded += historicalMatch.finalHomeGoals ;
             PlaysAtHomeorAway = "A";
             AwayTotalMatchCount+=1;
        }

        db.events.update({_id:it._id},{$push : { HomeTeamStats: {"Date":historicalMatch.startingat,
                                                         "PlaysAtHomeOrAway":PlaysAtHomeorAway,
                                                         "awayGoalsUpTo75":historicalMatch.awayGoalsUpTo75, 
                                                         "homeGoalsUpTo75":historicalMatch.homeGoalsUpTo75,
                                                         "finalAwayGoals":historicalMatch.finalAwayGoals,
                                                         "finalHomeGoals":historicalMatch.finalHomeGoals, 
                                                         "ResultAt75":historicalMatch.resultAt75,
                                                         "MatchNumber":historicalMatch.MatchNumber
                                                   }
                                           }
                              }
                             );   
                    
    });
    
        HomeAvgGoalsScoredUpTo75 = HomeAvgGoalsScoredUpTo75/HomeTotalMatchCount;
        HomeAvgGoalsConcededUpTo75 = HomeAvgGoalsConcededUpTo75/HomeTotalMatchCount;
        HomeAvgGoalsConceded =HomeAvgGoalsConceded/HomeTotalMatchCount;
        HomeAvgGoalsScored =HomeAvgGoalsScored/HomeTotalMatchCount;
        
        AwayAvgGoalsScoredUpTo75 = AwayAvgGoalsScoredUpTo75/AwayTotalMatchCount;
        AwayAvgGoalsConcededUpTo75 = AwayAvgGoalsConcededUpTo75/AwayTotalMatchCount;
        AwayAvgGoalsConceded =AwayAvgGoalsConceded/AwayTotalMatchCount;
        AwayAvgGoalsScored =AwayAvgGoalsScored/AwayTotalMatchCount;
    
        db.events.update({_id:it._id},
        {
                $set:
                {
                     "HomeTeamHomeAvgGoalsScoredUpTo75":HomeAvgGoalsScoredUpTo75,
                     "HomeTeamHomeAvgGoalsConcededUpTo75":HomeAvgGoalsConcededUpTo75,
                     "HomeTeamHomeAvgGoalsConceded":HomeAvgGoalsConceded,
                     "HomeTeamHomeAvgGoalsScored":HomeAvgGoalsScored,
         
                     "HomeTeamAwayAvgGoalsScoredUpTo75":AwayAvgGoalsScoredUpTo75,
                     "HomeTeamAwayAvgGoalsConcededUpTo75":AwayAvgGoalsConcededUpTo75,
                     "HomeTeamAwayAvgGoalsConceded":AwayAvgGoalsConceded,
                     "HomeTeamAwayAvgGoalsScored":AwayAvgGoalsScored
                }
        });



    HomeAvgGoalsScoredUpTo75 = 0;
    HomeAvgGoalsConcededUpTo75 = 0;
    HomeAvgGoalsConceded = 0;
    HomeAvgGoalsScored = 0;
    PlaysAtHomeorAway ="";
    HomeTotalMatchCount =0;

    AwayAvgGoalsScoredUpTo75 = 0;
    AwayAvgGoalsConcededUpTo75 = 0;
    AwayAvgGoalsConceded = 0;
    AwayAvgGoalsScored = 0;
    PlaysAtHomeorAway ="";
    AwayTotalMatchCount =0;

    AwayTeamhistoricalMatches.limit(numberOfPastGames).forEach((historicalMatch)=> 
    { 
        if (it.awayteamname ==historicalMatch.awayteamname)
        {
             AwayAvgGoalsScoredUpTo75 +=historicalMatch.awayGoalsUpTo75;
             AwayAvgGoalsScored +=historicalMatch.finalAwayGoals; 
             AwayAvgGoalsConcededUpTo75 += historicalMatch.homeGoalsUpTo75;
             AwayAvgGoalsConceded += historicalMatch.finalHomeGoals ;
             PlaysAtHomeorAway = "A";
             AwayTotalMatchCount+=1;
        }
        else     
        {
            HomeAvgGoalsScoredUpTo75 +=historicalMatch.homeGoalsUpTo75;
            HomeAvgGoalsScored +=historicalMatch.finalHomeGoals ;
            HomeAvgGoalsConcededUpTo75 += historicalMatch.awayGoalsUpTo75;
            HomeAvgGoalsConceded += historicalMatch.finalAwayGoals;
            PlaysAtHomeorAway = "H";
            HomeTotalMatchCount+=1;
        }


        db.events.update({_id:it._id},{$push : { AwayTeamStats: {"Date":historicalMatch.startingat,
                                                         "PlaysAtHomeOrAway":PlaysAtHomeorAway,
                                                         "awayGoalsUpTo75":historicalMatch.awayGoalsUpTo75, 
                                                         "homeGoalsUpTo75":historicalMatch.homeGoalsUpTo75,
                                                         "finalAwayGoals":historicalMatch.finalAwayGoals,
                                                         "finalHomeGoals":historicalMatch.finalHomeGoals, 
                                                         "ResultAt75":historicalMatch.resultAt75,
                                                         "MatchNumber":historicalMatch.MatchNumber
                                                   }
                                           }
                              }
                             );   
                    
    });

        
        HomeAvgGoalsScoredUpTo75 = HomeAvgGoalsScoredUpTo75/HomeTotalMatchCount;
        HomeAvgGoalsConcededUpTo75 = HomeAvgGoalsConcededUpTo75/HomeTotalMatchCount;
        HomeAvgGoalsConceded =HomeAvgGoalsConceded/HomeTotalMatchCount;
        HomeAvgGoalsScored =HomeAvgGoalsScored/HomeTotalMatchCount;

        AwayAvgGoalsScoredUpTo75 = AwayAvgGoalsScoredUpTo75/AwayTotalMatchCount;
        AwayAvgGoalsConcededUpTo75 = AwayAvgGoalsConcededUpTo75/AwayTotalMatchCount;
        AwayAvgGoalsConceded =AwayAvgGoalsConceded/AwayTotalMatchCount;
        AwayAvgGoalsScored =AwayAvgGoalsScored/AwayTotalMatchCount;
    
        db.events.update({_id:it._id},
        {
                $set:
                {
                     "AwayTeamHomeAvgGoalsScoredUpTo75":HomeAvgGoalsScoredUpTo75,
                     "AwayTeamHomeAvgGoalsConcededUpTo75":HomeAvgGoalsConcededUpTo75,
                     "AwayTeamHomeAvgGoalsConceded":HomeAvgGoalsConceded,
                     "AwayTeamHomeAvgGoalsScored":HomeAvgGoalsScored,
         
                     "AwayTeamAwayAvgGoalsScoredUpTo75":AwayAvgGoalsScoredUpTo75,
                     "AwayTeamAwayAvgGoalsConcededUpTo75":AwayAvgGoalsConcededUpTo75,
                     "AwayTeamAwayAvgGoalsConceded":AwayAvgGoalsConceded,
                     "AwayTeamAwayAvgGoalsScored":AwayAvgGoalsScored
                }
        });

    
});



function  getMatchNumber(currentDate, games)
{
    
    if (games===null)
        return 1;
    
    if (games.count()==0)
        return 1;

    var thegame = games[0];  
   
  
    var dt1 = new Date(currentDate);
    var dt2 = new Date(thegame.startingat);
    var days = Math.floor((Date.UTC(dt2.getFullYear(), dt2.getMonth(), dt2.getDate()) - Date.UTC(dt1.getFullYear(), dt1.getMonth(), dt1.getDate()) ) /(1000 * 60 * 60 * 24));

    if (days<-45)
        return 1;
  
    return thegame.MatchNumber+1;
}
